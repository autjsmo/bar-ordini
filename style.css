// qr-ordini-api Worker
export default {
  async fetch(request, env) {
    const url = new URL(request.url);
    const path = url.pathname;
    const method = request.method;

    // CORS headers
    const allowedOrigins = [
      'https://autjsmo.github.io',
      'http://localhost:3000'
    ];
    const origin = request.headers.get('Origin');
    const corsHeaders = {
      'Access-Control-Allow-Origin': allowedOrigins.includes(origin) ? origin : allowedOrigins[0],
      'Access-Control-Allow-Methods': 'GET, POST, PATCH, DELETE, OPTIONS',
      'Access-Control-Allow-Headers': 'Content-Type, Authorization',
    };

    if (method === 'OPTIONS') {
      return new Response(null, { headers: corsHeaders });
    }

    const jsonResponse = (data, status = 200) => {
      return new Response(JSON.stringify(data), {
        status,
        headers: { ...corsHeaders, 'Content-Type': 'application/json' }
      });
    };

    const isAdmin = (req) => {
      const auth = req.headers.get('Authorization');
      return auth === `Bearer ${env.ADMIN_PASSWORD}`;
    };

    const randPin = () => String(Math.floor(1000 + Math.random() * 9000));
    const uuid = () => crypto.randomUUID();

    try {
      // === SESSIONI ===

      if (path === '/session/open' && method === 'POST') {
        if (!isAdmin(request)) return jsonResponse({ error: 'Unauthorized' }, 401);
        const { table_id } = await request.json();
        if (!table_id) return jsonResponse({ error: 'table_id required' }, 400);

        await env.DB.prepare('UPDATE sessions SET status = ?, closed_at = ? WHERE table_id = ? AND status = ?')
          .bind('closed', Date.now(), table_id, 'open').run();

        const pin = randPin();
        const sessionId = uuid();
        await env.DB.prepare('INSERT INTO sessions (id, table_id, pin, opened_at, status) VALUES (?, ?, ?, ?, ?)')
          .bind(sessionId, table_id, pin, Date.now(), 'open').run();

        return jsonResponse({ session_id: sessionId, pin, table_id });
      }

      if (path === '/session/close' && method === 'POST') {
        if (!isAdmin(request)) return jsonResponse({ error: 'Unauthorized' }, 401);
        const { table_id } = await request.json();
        if (!table_id) return jsonResponse({ error: 'table_id required' }, 400);

        await env.DB.prepare('UPDATE sessions SET status = ?, closed_at = ? WHERE table_id = ? AND status = ?')
          .bind('closed', Date.now(), table_id, 'open').run();

        return jsonResponse({ success: true, table_id });
      }

      if (path === '/session/verify' && method === 'POST') {
        const { table_id, pin } = await request.json();
        if (!table_id || !pin) return jsonResponse({ error: 'table_id and pin required' }, 400);

        const session = await env.DB.prepare('SELECT id, status FROM sessions WHERE table_id = ? AND pin = ? AND status = ?')
          .bind(table_id, pin, 'open').first();

        if (!session) return jsonResponse({ error: 'Invalid PIN or session closed' }, 403);

        return jsonResponse({ token: session.id, session_id: session.id, table_id });
      }

      // === ORDINI ===

      if (path === '/orders' && method === 'POST') {
        const { token, items } = await request.json();
        if (!token || !items || items.length === 0) return jsonResponse({ error: 'token and items required' }, 400);

        const session = await env.DB.prepare('SELECT id, table_id, status FROM sessions WHERE id = ? AND status = ?')
          .bind(token, 'open').first();
        if (!session) return jsonResponse({ error: 'Invalid or closed session' }, 403);

        const orderId = uuid();
        await env.DB.prepare('INSERT INTO orders (id, session_id, state, created_at) VALUES (?, ?, ?, ?)')
          .bind(orderId, session.id, 'richiesta', Date.now()).run();

        for (const item of items) {
          await env.DB.prepare('INSERT INTO order_items (id, order_id, item_id, item_name, quantity, unit_price_eur) VALUES (?, ?, ?, ?, ?, ?)')
            .bind(uuid(), orderId, item.item_id, item.name, item.quantity, item.price_eur).run();
        }

        return jsonResponse({ order_id: orderId, state: 'richiesta' }, 201);
      }

      // âœ… NUOVO: GET /orders/mine - Storico ordini della sessione (cliente)
      if (path === '/orders/mine' && method === 'GET') {
        const token = url.searchParams.get('token') || request.headers.get('Authorization')?.replace(/^Bearer\s+/i, '');
        if (!token) return jsonResponse({ error: 'token required' }, 400);

        // Verifica token (session aperta)
        const session = await env.DB.prepare('SELECT id, table_id, status FROM sessions WHERE id = ? AND status = ?')
          .bind(token, 'open').first();
        if (!session) return jsonResponse({ error: 'Invalid or closed session' }, 403);

        // Prendi ordini della sessione
        const { results: orders } = await env.DB.prepare(`
          SELECT o.id, o.session_id, o.state, o.created_at, ? as table_id
          FROM orders o
          WHERE o.session_id = ?
          ORDER BY o.created_at DESC
        `).bind(session.table_id, session.id).all();

        for (const order of orders) {
          const { results: items } = await env.DB.prepare(
            'SELECT item_name, quantity, unit_price_eur FROM order_items WHERE order_id = ?'
          ).bind(order.id).all();
          order.items = items;
        }

        return jsonResponse({ orders });
      }

      // GET /orders - Lista ordini (admin)
      if (path === '/orders' && method === 'GET') {
        if (!isAdmin(request)) return jsonResponse({ error: 'Unauthorized' }, 401);

        const tableFilter = url.searchParams.get('table_id');
        const stateFilter = url.searchParams.get('state');
        const sessionFilter = url.searchParams.get('session_id');

        let query = `
          SELECT o.id, o.session_id, o.state, o.created_at, s.table_id
          FROM orders o
          JOIN sessions s ON o.session_id = s.id
          WHERE 1=1
        `;
        const bindings = [];

        if (sessionFilter) {
          query += ' AND o.session_id = ?';
          bindings.push(sessionFilter);
        } else if (tableFilter) {
          query += ' AND s.table_id = ?';
          bindings.push(tableFilter);
        }

        if (stateFilter) {
          query += ' AND o.state = ?';
          bindings.push(stateFilter);
        }

        query += ' ORDER BY o.created_at DESC';

        const { results: orders } = await env.DB.prepare(query).bind(...bindings).all();

        for (const order of orders) {
          const { results: items } = await env.DB.prepare(
            'SELECT item_name, quantity, unit_price_eur FROM order_items WHERE order_id = ?'
          ).bind(order.id).all();
          order.items = items;
        }

        return jsonResponse({ orders });
      }

      if (path.startsWith('/orders/') && method === 'PATCH') {
        if (!isAdmin(request)) return jsonResponse({ error: 'Unauthorized' }, 401);
        const orderId = path.split('/')[2];
        const { state } = await request.json();
        if (!state) return jsonResponse({ error: 'state required' }, 400);

        await env.DB.prepare('UPDATE orders SET state = ? WHERE id = ?').bind(state, orderId).run();
        return jsonResponse({ success: true, order_id: orderId, state });
      }

      // === MENU ===

      if (path === '/menu' && method === 'GET') {
        const { results: categories } = await env.DB.prepare('SELECT * FROM menu_categories ORDER BY position').all();
        const { results: items } = await env.DB.prepare('SELECT * FROM menu_items WHERE visible = 1 ORDER BY position').all();
        return jsonResponse({ categories, items });
      }

      if (path === '/menu/admin' && method === 'GET') {
        if (!isAdmin(request)) return jsonResponse({ error: 'Unauthorized' }, 401);
        const { results: categories } = await env.DB.prepare('SELECT * FROM menu_categories ORDER BY position').all();
        const { results: items } = await env.DB.prepare('SELECT * FROM menu_items ORDER BY position').all();
        return jsonResponse({ categories, items });
      }

      if (path === '/menu/categories' && method === 'POST') {
        if (!isAdmin(request)) return jsonResponse({ error: 'Unauthorized' }, 401);
        const { name, position } = await request.json();
        if (!name) return jsonResponse({ error: 'name required' }, 400);
        const id = uuid();
        await env.DB.prepare('INSERT INTO menu_categories (id, name, position) VALUES (?, ?, ?)')
          .bind(id, name, position || 999).run();
        return jsonResponse({ id, name, position }, 201);
      }

      if (path.startsWith('/menu/categories/') && method === 'PATCH') {
        if (!isAdmin(request)) return jsonResponse({ error: 'Unauthorized' }, 401);
        const catId = path.split('/')[3];
        const { name, position } = await request.json();
        let query = 'UPDATE menu_categories SET';
        const bindings = [];
        if (name !== undefined) { query += ' name = ?'; bindings.push(name); }
        if (position !== undefined) { query += (bindings.length ? ',' : '') + ' position = ?'; bindings.push(position); }
        query += ' WHERE id = ?';
        bindings.push(catId);
        await env.DB.prepare(query).bind(...bindings).run();
        return jsonResponse({ success: true, id: catId });
      }

      if (path.startsWith('/menu/categories/') && method === 'DELETE') {
        if (!isAdmin(request)) return jsonResponse({ error: 'Unauthorized' }, 401);
        const catId = path.split('/')[3];
        await env.DB.prepare('DELETE FROM menu_items WHERE category_id = ?').bind(catId).run();
        await env.DB.prepare('DELETE FROM menu_categories WHERE id = ?').bind(catId).run();
        return jsonResponse({ success: true, id: catId });
      }

      if (path === '/menu/items' && method === 'POST') {
        if (!isAdmin(request)) return jsonResponse({ error: 'Unauthorized' }, 401);
        const { category_id, name, price_eur, description, tags, visible, position } = await request.json();
        if (!category_id || !name || price_eur === undefined) return jsonResponse({ error: 'category_id, name, price_eur required' }, 400);
        const id = uuid();
        const tagsStr = tags ? JSON.stringify(tags) : null;
        await env.DB.prepare('INSERT INTO menu_items (id, category_id, name, price_eur, description, tags, visible, position) VALUES (?, ?, ?, ?, ?, ?, ?, ?)')
          .bind(id, category_id, name, price_eur, description || null, tagsStr, visible ? 1 : 0, position || 999).run();
        return jsonResponse({ id, name, price_eur }, 201);
      }

      if (path.startsWith('/menu/items/') && method === 'PATCH') {
        if (!isAdmin(request)) return jsonResponse({ error: 'Unauthorized' }, 401);
        const itemId = path.split('/')[3];
        const data = await request.json();
        const fields = [];
        const bindings = [];
        if (data.name !== undefined) { fields.push('name = ?'); bindings.push(data.name); }
        if (data.price_eur !== undefined) { fields.push('price_eur = ?'); bindings.push(data.price_eur); }
        if (data.description !== undefined) { fields.push('description = ?'); bindings.push(data.description); }
        if (data.tags !== undefined) { fields.push('tags = ?'); bindings.push(JSON.stringify(data.tags)); }
        if (data.visible !== undefined) { fields.push('visible = ?'); bindings.push(data.visible ? 1 : 0); }
        if (data.position !== undefined) { fields.push('position = ?'); bindings.push(data.position); }
        if (fields.length === 0) return jsonResponse({ error: 'No fields to update' }, 400);
        bindings.push(itemId);
        await env.DB.prepare(`UPDATE menu_items SET ${fields.join(', ')} WHERE id = ?`).bind(...bindings).run();
        return jsonResponse({ success: true, id: itemId });
      }

      if (path.startsWith('/menu/items/') && method === 'DELETE') {
        if (!isAdmin(request)) return jsonResponse({ error: 'Unauthorized' }, 401);
        const itemId = path.split('/')[3];
        await env.DB.prepare('DELETE FROM menu_items WHERE id = ?').bind(itemId).run();
        return jsonResponse({ success: true, id: itemId });
      }

      // === STATISTICHE ===

      if (path === '/stats/top-items' && method === 'GET') {
        if (!isAdmin(request)) return jsonResponse({ error: 'Unauthorized' }, 401);
        const from = url.searchParams.get('from');
        const to = url.searchParams.get('to');

        let query = 'SELECT item_name, SUM(quantity) as total FROM order_items oi JOIN orders o ON oi.order_id = o.id WHERE o.state = ?';
        const bindings = ['servito'];
        if (from) { query += ' AND o.created_at >= ?'; bindings.push(new Date(from).getTime()); }
        if (to) { query += ' AND o.created_at <= ?'; bindings.push(new Date(to).getTime()); }
        query += ' GROUP BY item_name ORDER BY total DESC';

        const { results } = await env.DB.prepare(query).bind(...bindings).all();
        return jsonResponse({ top_items: results });
      }

      if (path === '/stats/tables-opened' && method === 'GET') {
        if (!isAdmin(request)) return jsonResponse({ error: 'Unauthorized' }, 401);
        const from = url.searchParams.get('from');
        const to = url.searchParams.get('to');

        let query = 'SELECT DATE(opened_at/1000, "unixepoch") as day, COUNT(*) as count FROM sessions WHERE 1=1';
        const bindings = [];
        if (from) { query += ' AND opened_at >= ?'; bindings.push(new Date(from).getTime()); }
        if (to) { query += ' AND opened_at <= ?'; bindings
